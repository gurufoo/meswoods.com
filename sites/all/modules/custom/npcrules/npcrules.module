<?php

function npcrules_form_npc_node_form_alter (&$form, &$form_state, $form_id) {
  //dpm($form_id, '$form_id');
  //dpm($form_state, '$form_state');
  //dpm($form, '$form');
  
  if (isset($form_state['build_info']['args'][0]->nid)) {
    //dpm('nid exists, we are on an existing npc');
  } else {  //no nid, this is a new npc do awesome stuff here
      // First things first, pre-select all values on all of the fields listed in
      // the $fields_to_select_all array.
      $fields_to_select_all = _get_random_npc_fields();
      foreach ($fields_to_select_all as $field) {
        foreach ($form[$field]['und']['#options'] as $key => $value) {
          $selected_options[] = $key;
        }
      $form[$field]['und']['#default_value'] = $selected_options;
    }
    // Add a validate handler to randomly select from all the fields selected
    $form['#validate'][] = 'npc_select_random_options_all'; // Select random values for all the multiselect fields
    $form['#validate'][] = 'facial_hair_female_no_hair'; // Females don't have facial  hair
    $form['#validate'][] = 'facial_hair_male_dwarf_likely'; // Male Dwarves are likely to have facial hair
  }
}
/**
 * Facial hair rules.  And these are the criteria and responses governing
 * facial hair ;^)
 */
module_load_include('inc', 'npcrules', 'inc/facial_hair.rules');

/**
 * Select random values for all the multiselect fields
 */
function npc_select_random_options_all ($form, &$form_state) {
  $fields = _get_random_npc_fields();
  foreach ($fields as $field) {
    $random = array_rand($form_state['values'][$field]['und']);
    $value = $form_state['values'][$field]['und'][$random]['value'];
    //dpm($field, '$field');
    //dpm($value, '$value');
    form_set_value($form[$field], array('und' => array(0 => array('value' => $value))), $form_state);
  }
}


/**
 * Retrieves a list of elements (fields). Often this is used to operate on all
 * the fields that will have random values.
 *
 * @return array An array of elements (fields).
 */
function _get_random_npc_fields () {
  return array(
        'field_facial_hair_style',
        'field_hair_color',
        'field_gender',
        'field_npc_race',
        'field_npc_mannerisms',
        'field_distinguishing_features');
}

/**
 * Retrieves a list of options from a form element.  Typically this is used
 * to get all the options in order to select a random option.
 
 * @param array $form A Drupal FAPI form array
 * @param string $field The machine name for an element
 *
 * @return array An array of options for the element
 */
function _getopts ($form, $field) {
  return $form[$field]['und']['#options'];
}


/**
 * Roll percentile dice and determine the result
 * 
 * @param int $chance The % chance that something is true
 *
 * @return boolean
 */
function _rollpercentile ($chance = 50) {
  $roll = rand(1, 100);
  if ($roll < $chance) { 
    return TRUE;
  }else {
    return FALSE;
  }
}